<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ì—…ë¡œë“œ - êµ¬ë¦„í™˜ê²½ íŒë§¤ë°ì´í„° ë¶„ì„</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .navbar h1 { color: white; font-size: 20px; }
        .navbar-right { display: flex; align-items: center; gap: 20px; }
        .navbar-right span { color: white; }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary { background: #4CAF50; color: white; }
        .btn-primary:hover { background: #45a049; }
        .btn-secondary { background: rgba(255, 255, 255, 0.2); color: white; }
        .btn-secondary:hover { background: rgba(255, 255, 255, 0.3); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-info { background: #3498db; color: white; }
        .btn-info:hover { background: #2980b9; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px; }

        .page-header { margin-bottom: 30px; }
        .page-header h2 { font-size: 24px; color: #333; margin-bottom: 10px; }
        .page-header p { color: #666; }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 50px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover { transform: scale(1.02); }
        .upload-icon { font-size: 60px; margin-bottom: 20px; }
        .upload-area h3 { font-size: 20px; color: #333; margin-bottom: 10px; }
        .upload-area p { color: #666; margin-bottom: 20px; }
        .upload-area input[type="file"] { display: none; }

        .file-types { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .file-type-badge {
            background: #e8f4fd;
            color: #3498db;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .file-type-select {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-type-option {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .file-type-option:hover { border-color: #667eea; }
        .file-type-option.selected { border-color: #667eea; background: #f8f9ff; }
        .file-type-option h4 { font-size: 16px; color: #333; margin-bottom: 5px; }
        .file-type-option p { font-size: 12px; color: #888; }
        .file-type-option .icon { font-size: 30px; margin-bottom: 10px; }

        .upload-progress { display: none; margin-top: 20px; }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        .progress-text { text-align: center; margin-top: 10px; color: #666; }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        .data-table tr:hover { background: #f8f9fa; }
        .data-table td { font-size: 14px; color: #555; }

        .file-size { color: #888; }
        .file-date { color: #888; }
        .file-type {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        .file-type.original { background: #e3f2fd; color: #1976d2; }
        .file-type.monthly { background: #f3e5f5; color: #7b1fa2; }
        .file-type.custom { background: #fff3e0; color: #f57c00; }

        .row-count { color: #27ae60; font-weight: 500; }

        .action-btns { display: flex; gap: 8px; }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        .toast.info { background: #3498db; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .empty-state { text-align: center; padding: 50px; color: #888; }
        .empty-state .icon { font-size: 60px; margin-bottom: 20px; }

        .db-info {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .db-info .icon { font-size: 24px; }
        .db-info .text { color: #2e7d32; }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .file-type-select { flex-direction: column; }
            .upload-area { padding: 30px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>â˜ï¸ êµ¬ë¦„í™˜ê²½ íŒë§¤ë°ì´í„° ë¶„ì„</h1>
        <div class="navbar-right">
            <span>ğŸ‘¤ {{ session.username }} ë‹˜</span>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">ğŸ“ˆ ëŒ€ì‹œë³´ë“œ</a>
            <a href="{{ url_for('logout') }}" class="btn btn-danger">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>ğŸ“ ë°ì´í„° ì—…ë¡œë“œ</h2>
            <p>Excel ë˜ëŠ” CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="db-info">
            <span class="icon">ğŸ’¾</span>
            <span class="text">ì—…ë¡œë“œëœ ë°ì´í„°ëŠ” Supabaseì— ì €ì¥ë©ë‹ˆë‹¤. ë¶„ë¥˜ëª…ì—ì„œ ì—…ì²´ëª…ê³¼ ì¹´í…Œê³ ë¦¬ê°€ ìë™ ë¶„ë¥˜ë©ë‹ˆë‹¤.</span>
            <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                <span id="dataCountsDisplay" style="font-size: 12px;">ë¡œë”©ì¤‘...</span>
{% if is_admin %}
                <button class="btn btn-info btn-sm" onclick="createBackup()" style="white-space: nowrap;">ğŸ’¾ ë°±ì—…</button>
                <button class="btn btn-secondary btn-sm" onclick="showBackupList()" style="white-space: nowrap; background: #8e44ad;">ğŸ“‚ ë°±ì—… ëª©ë¡</button>
                <button class="btn btn-sm" onclick="showYearDeleteModal()" style="white-space: nowrap; background: #e67e22; color: white;">ğŸ“… ì—°ë„ë³„ ì‚­ì œ</button>
                <button class="btn btn-danger btn-sm" onclick="resetAllData()" style="white-space: nowrap;">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
                {% endif %}
            </div>
        </div>

        <!-- ë°±ì—… ëª©ë¡ ëª¨ë‹¬ -->
        <div id="backupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ“‚ ë°±ì—… ëª©ë¡</h3>
                    <button onclick="closeBackupModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
                </div>
                <div id="backupListContent">
                    <p style="text-align: center; color: #888;">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>

        <!-- ì—°ë„ë³„ ì‚­ì œ ëª¨ë‹¬ -->
        <div id="yearDeleteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0;">ğŸ“… ì—°ë„ë³„ ë°ì´í„° ì‚­ì œ</h3>
                    <button onclick="closeYearDeleteModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">Ã—</button>
                </div>
                <div style="margin-bottom: 20px;">
                    <p style="color: #666; margin-bottom: 15px;">
                        íŠ¹ì • ì—°ë„ì˜ ì›”ë³„ íŒë§¤ ë°ì´í„°ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.<br>
                        <strong style="color: #e74c3c;">âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</strong>
                    </p>
                    <p style="color: #3498db; font-size: 14px; margin-bottom: 15px;">
                        ğŸ’¡ <strong>Tip:</strong> ì‚­ì œ ì „ 'ë°±ì—…' ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì„¸ìš”.<br>
                        ë°±ì—… íŒŒì¼ì€ <code>./backups/</code> í´ë”ì— JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
                    </p>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">ì‚­ì œí•  ì—°ë„ ì„ íƒ:</label>
                    <select id="yearSelect" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="">ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <div id="yearDeleteInfo" style="display: none; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <p id="yearDeleteInfoText" style="margin: 0; color: #856404;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-danger" onclick="deleteByYear()" style="flex: 1;">ğŸ—‘ï¸ ì‚­ì œ</button>
                    <button class="btn btn-secondary" onclick="closeYearDeleteModal()" style="flex: 1; background: #888;">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>

        <!-- ì—…ë¡œë“œ ì¹´ë“œ -->
        <div class="card">
            <h3 class="card-title">ìƒˆ íŒŒì¼ ì—…ë¡œë“œ</h3>

            {% if not is_admin %}
            <div style="padding: 40px; text-align: center; color: #666;">
                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”’</div>
                <h4 style="margin-bottom: 8px;">ì½ê¸° ì „ìš© ê³„ì •</h4>
                <p>íŒŒì¼ ì—…ë¡œë“œëŠ” ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
            {% else %}
            <!-- íŒŒì¼ íƒ€ì… ì„ íƒ -->
            <div class="file-type-select">
                <div class="file-type-option selected" data-type="original">
                    <div class="icon">ğŸ“‹</div>
                    <h4>ì›ë³¸ ë°ì´í„°</h4>
                    <p>ë¶„ë¥˜ëª…(ì—…ì²´ëª…) í˜•ì‹ì˜ íŒë§¤í˜„í™©</p>
                </div>
                <div class="file-type-option" data-type="monthly">
                    <div class="icon">ğŸ“…</div>
                    <h4>ì›”ë³„ ë°ì´í„°</h4>
                    <p>ì‹œíŠ¸ë³„(ì˜ë¥˜/ì‹ ë°œ/ì¡í™”) ë¶„ë¥˜ëœ ë°ì´í„°</p>
                </div>
                <div class="file-type-option" data-type="pos">
                    <div class="icon">ğŸ§¾</div>
                    <h4>POS ë°ì´í„°</h4>
                    <p>í¬ìŠ¤ê¸° íŒë§¤í˜„í™© (ìƒí’ˆë³„ ì›”ë³„ ì§‘ê³„)</p>
                </div>
                <div class="file-type-option" data-type="custom">
                    <div class="icon">ğŸ“‚</div>
                    <h4>ì»¤ìŠ¤í…€ ë°ì´í„°</h4>
                    <p>ê¸°íƒ€ ë¶„ì„ìš© ë°ì´í„°</p>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“¤</div>
                <h3>íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</h3>
                <p>ì—…ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ DBì— ì €ì¥ë©ë‹ˆë‹¤. (ìµœëŒ€ 50MB)</p>
                <input type="file" id="fileInput" accept=".xls,.xlsx,.csv">
                <div class="file-types">
                    <span class="file-type-badge">.xlsx</span>
                    <span class="file-type-badge">.xls</span>
                    <span class="file-type-badge">.csv</span>
                </div>
            </div>

            <!-- ì—…ë¡œë“œ ì§„í–‰ë¥  -->
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">ì—…ë¡œë“œ ì¤‘...</p>
            </div>

            <!-- ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ -->
            <div id="previewArea" style="display: none; margin-top: 20px;">
                <h4 style="margin-bottom: 15px;">ğŸ“Š ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°</h4>
                <div id="previewStats" style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;"></div>
                <div style="max-height: 300px; overflow: auto; border: 1px solid #eee; border-radius: 8px;">
                    <table class="data-table" id="previewTable">
                        <thead id="previewHeader"></thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="confirmUpload()">DBì— ì €ì¥</button>
                    <button class="btn btn-secondary" onclick="cancelPreview()" style="background: #888;">ì·¨ì†Œ</button>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- ì—…ë¡œë“œëœ íŒŒì¼ ëª©ë¡ -->
        <div class="card">
            <h3 class="card-title">ì €ì¥ëœ ë°ì´í„° ëª©ë¡ (DB)</h3>

            {% if files %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>íŒŒì¼ëª…</th>
                        <th>íƒ€ì…</th>
                        <th>ë°ì´í„° ìˆ˜</th>
                        <th>ì—…ë¡œë“œ ì¼ì‹œ</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td>{{ file.id }}</td>
                        <td>{{ file.original_name or file.filename }}</td>
                        <td>
                            <span class="file-type {{ file.file_type }}">
                                {% if file.file_type == 'original' %}ì›ë³¸{% elif file.file_type == 'monthly' %}ì›”ë³„{% else %}ì»¤ìŠ¤í…€{% endif %}
                            </span>
                        </td>
                        <td class="row-count">{{ "{:,}".format(file.row_count|int) }}í–‰</td>
                        <td class="file-date">{{ file.upload_date }}</td>
                        <td>
                            <div class="action-btns">
                                {% if is_admin %}
                                <button class="btn btn-danger btn-sm" onclick="deleteFile({{ file.id }}, '{{ file.filename }}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                                {% else %}
                                <span style="color: #999;">-</span>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let selectedFileType = 'original';
        let pendingData = null;  // ë¯¸ë¦¬ë³´ê¸° í›„ ì €ì¥ ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„°
        let pendingFile = null;  // ë¯¸ë¦¬ë³´ê¸° í›„ ì €ì¥ ëŒ€ê¸° ì¤‘ì¸ íŒŒì¼

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ì¹´ìš´íŠ¸ ì¡°íšŒ
        document.addEventListener('DOMContentLoaded', loadDataCounts);

        async function loadDataCounts() {
            try {
                const response = await fetch('/api/data-counts');
                const data = await response.json();
                if (data.success !== false) {
                    const total = (data.sales_data || 0) + (data.monthly_sales || 0);
                    document.getElementById('dataCountsDisplay').innerHTML =
                        `<span style="color: #27ae60;">ì›ë³¸: ${(data.sales_data || 0).toLocaleString()}ê±´</span> | ` +
                        `<span style="color: #8e44ad;">ì›”ë³„: ${(data.monthly_sales || 0).toLocaleString()}ê±´</span>`;
                }
            } catch (e) {
                document.getElementById('dataCountsDisplay').textContent = 'ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨';
            }
        }

        // ========== ë°±ì—… ê´€ë ¨ í•¨ìˆ˜ ==========
        async function createBackup() {
            if (!confirm('í˜„ì¬ ë°ì´í„°ë¥¼ ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                showToast('ë°±ì—… ìƒì„± ì¤‘...', 'info');
                const response = await fetch('/api/backup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    showToast(result.message, 'success');
                } else {
                    showToast('ë°±ì—… ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('ë°±ì—… ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        async function showBackupList() {
            const modal = document.getElementById('backupModal');
            const content = document.getElementById('backupListContent');
            modal.style.display = 'flex';
            content.innerHTML = '<p style="text-align: center; color: #888;">ë¡œë”© ì¤‘...</p>';

            try {
                const response = await fetch('/api/backup/list');
                const result = await response.json();

                if (!result.success) {
                    content.innerHTML = '<p style="color: #e74c3c;">ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: ' + result.error + '</p>';
                    return;
                }

                const backups = result.backups || [];
                if (backups.length === 0) {
                    content.innerHTML = '<p style="text-align: center; color: #888;">ì €ì¥ëœ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '<table class="data-table"><thead><tr><th>íŒŒì¼ëª…</th><th>ìƒì„±ì¼ì‹œ</th><th>í¬ê¸°</th><th>ì‘ì—…</th></tr></thead><tbody>';
                backups.forEach(backup => {
                    const size = (backup.size / 1024 / 1024).toFixed(2);
                    const date = new Date(backup.created).toLocaleString('ko-KR');
                    html += `<tr>
                        <td>${backup.filename}</td>
                        <td>${date}</td>
                        <td>${size} MB</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="restoreBackup('${backup.filename}')">ğŸ”„ ë³µì›</button>
                            <a href="/api/backup/download/${backup.filename}" class="btn btn-info btn-sm">â¬‡ï¸ ë‹¤ìš´ë¡œë“œ</a>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = '<p style="color: #e74c3c;">ì˜¤ë¥˜: ' + error.message + '</p>';
            }
        }

        function closeBackupModal() {
            document.getElementById('backupModal').style.display = 'none';
        }

        async function restoreBackup(filename) {
            if (!confirm('ì´ ë°±ì—…ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤!')) return;
            if (!confirm('ë§ˆì§€ë§‰ í™•ì¸: ì •ë§ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                showToast('ë³µì› ì¤‘...', 'info');
                const response = await fetch('/api/backup/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ë³µì› ì™„ë£Œ!', 'success');
                    closeBackupModal();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('ë³µì› ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('ë³µì› ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // ========== ë°ì´í„° ì´ˆê¸°í™” ==========
        async function resetAllData() {
            if (!confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ’¡ ì´ˆê¸°í™” ì „ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤!')) return;
            if (!confirm('ë§ˆì§€ë§‰ í™•ì¸: ëª¨ë“  íŒë§¤ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/reset-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (result.success) {
                    showToast('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('ì´ˆê¸°í™” ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ========== ì—°ë„ë³„ ì‚­ì œ ==========
        async function showYearDeleteModal() {
            const modal = document.getElementById('yearDeleteModal');
            const yearSelect = document.getElementById('yearSelect');
            modal.style.display = 'flex';

            // ì—°ë„ ëª©ë¡ ë¡œë“œ
            yearSelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';
            try {
                const response = await fetch('/api/available-years');
                const result = await response.json();

                if (result.success && result.years && result.years.length > 0) {
                    yearSelect.innerHTML = '<option value="">ì—°ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                    result.years.forEach(year => {
                        yearSelect.innerHTML += `<option value="${year}">${year}ë…„</option>`;
                    });
                } else {
                    yearSelect.innerHTML = '<option value="">ë°ì´í„°ê°€ ìˆëŠ” ì—°ë„ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                }
            } catch (error) {
                yearSelect.innerHTML = '<option value="">ì—°ë„ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨</option>';
            }

            // ì •ë³´ ì˜ì—­ ìˆ¨ê¸°ê¸°
            document.getElementById('yearDeleteInfo').style.display = 'none';
        }

        function closeYearDeleteModal() {
            document.getElementById('yearDeleteModal').style.display = 'none';
        }

        async function deleteByYear() {
            const yearSelect = document.getElementById('yearSelect');
            const year = yearSelect.value;

            if (!year) {
                showToast('ì‚­ì œí•  ì—°ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!confirm(`${year}ë…„ë„ì˜ ëª¨ë“  ì›”ë³„ íŒë§¤ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) return;
            if (!confirm(`ë§ˆì§€ë§‰ í™•ì¸: ${year}ë…„ë„ ë°ì´í„°ê°€ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

            try {
                showToast('ì‚­ì œ ì¤‘...', 'info');
                const response = await fetch('/api/delete-by-year', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ year: parseInt(year) })
                });
                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    closeYearDeleteModal();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast('ì‚­ì œ ì‹¤íŒ¨: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        // íŒŒì¼ íƒ€ì… ì„ íƒ
        document.querySelectorAll('.file-type-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.file-type-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedFileType = option.dataset.type;
            });
        });

        // ì—…ë¡œë“œ ì˜ì—­ í´ë¦­
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        });

        // POS ë°ì´í„°ë¥¼ ì›”ë³„ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function convertPosToMonthly(posRows, year = 2025) {
            const monthlyRows = [];
            const monthNames = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];

            for (const row of posRows) {
                const productName = row['ìƒí’ˆëª…'] || row['í’ˆëª…'] || '';
                if (!productName) continue;

                // ê° ì›”ë³„ ë°ì´í„°ë¥¼ ë³„ë„ í–‰ìœ¼ë¡œ ë³€í™˜
                for (let m = 0; m < 12; m++) {
                    const monthCol = monthNames[m];
                    const qty = parseFloat(row[monthCol]) || 0;

                    if (qty > 0) {
                        // í•´ë‹¹ ì›”ì˜ 15ì¼ë¡œ ë‚ ì§œ ì„¤ì •
                        const dateStr = `${year}-${String(m + 1).padStart(2, '0')}-15`;

                        monthlyRows.push({
                            'íŒë§¤ì¼ì': dateStr,
                            'ë§¤ì¥ëª…': 'POS',
                            'ìƒí’ˆì½”ë“œ': '',
                            'ìƒí’ˆëª…': productName,
                            'ë¶„ë¥˜ëª…': '',
                            'íŒë§¤ëŸ‰': qty,
                            'ì‹¤íŒë§¤ê¸ˆì•¡': 0,  // POS ë°ì´í„°ì— ê¸ˆì•¡ì´ ì—†ìœ¼ë©´ 0
                            '_source': 'pos'
                        });
                    }
                }
            }

            return monthlyRows;
        }

        async function handleFile(file) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!['xls', 'xlsx', 'csv'].includes(ext)) {
                showToast('í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.', 'error');
                return;
            }

            // íŒŒì¼ì„ íŒŒì‹±í•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const progressDiv = document.getElementById('uploadProgress');
            const progressText = document.getElementById('progressText');
            progressDiv.style.display = 'block';
            progressText.textContent = 'íŒŒì¼ ë¶„ì„ ì¤‘...';

            try {
                let allRows = [];
                let sheetInfo = [];

                // ì›ë³¸ ë°ì´í„° (.xls í™•ì¥ìì§€ë§Œ ì‹¤ì œ TSV í˜•ì‹) ë˜ëŠ” CSVëŠ” í…ìŠ¤íŠ¸ë¡œ íŒŒì‹±
                if (selectedFileType === 'original' || ext === 'csv') {
                    const text = await readFileAsText(file, 'euc-kr');
                    const lines = text.split('\n').filter(line => line.trim());

                    if (lines.length < 2) {
                        throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    }

                    const delimiter = lines[0].includes('\t') ? '\t' : ',';
                    const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                        if (values.length >= headers.length - 5) {
                            const row = {};
                            headers.forEach((header, idx) => {
                                row[header] = values[idx] !== undefined ? values[idx] : null;
                            });
                            allRows.push(row);
                        }
                    }
                } else if (selectedFileType === 'pos') {
                    // POS ë°ì´í„° (ìƒí’ˆëª…, í•©ê³„, 1ì›”~12ì›” í˜•ì‹)
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data, {
                        type: 'array',
                        codepage: 949,
                        raw: false,
                        cellText: true
                    });

                    let posRows = [];
                    for (const sheetName of workbook.SheetNames) {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, {
                            defval: null,
                            raw: false
                        });
                        posRows = posRows.concat(jsonData);
                    }

                    // íŒŒì¼ëª…ì—ì„œ ì—°ë„ ì¶”ì¶œ ì‹œë„ (ì˜ˆ: "25ë…„ë„" -> 2025)
                    let year = 2025;
                    const yearMatch = file.name.match(/(\d{2,4})ë…„/);
                    if (yearMatch) {
                        year = yearMatch[1].length === 2 ? 2000 + parseInt(yearMatch[1]) : parseInt(yearMatch[1]);
                    }

                    // POS í˜•ì‹ì„ ì›”ë³„ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    allRows = convertPosToMonthly(posRows, year);

                    // íŒŒì¼ íƒ€ì…ì„ monthlyë¡œ ë³€ê²½í•˜ì—¬ ì €ì¥
                    sheetInfo.push({
                        sheetName: 'POS',
                        dataType: file.name.includes('ì˜ë¥˜') ? 'ì˜ë¥˜' : file.name.includes('ì‹ ë°œ') ? 'ì‹ ë°œ' : file.name.includes('ì¡í™”') ? 'ì¡í™”' : 'POS',
                        startIdx: 0,
                        count: allRows.length
                    });

                    console.log(`POS ë°ì´í„° ë³€í™˜ ì™„ë£Œ: ${posRows.length}ê°œ ìƒí’ˆ â†’ ${allRows.length}ê°œ ì›”ë³„ ë ˆì½”ë“œ`);
                } else {
                    // ì§„ì§œ Excel íŒŒì¼ (.xlsx, ì›”ë³„ ë°ì´í„°)
                    const data = await file.arrayBuffer();
                    // raw: trueë¡œ ì›ì‹œ ë°ì´í„° ìœ ì§€, ì¸ì½”ë”© ë¬¸ì œ ë°©ì§€
                    const workbook = XLSX.read(data, {
                        type: 'array',
                        codepage: 949,
                        raw: false,
                        cellText: true,
                        cellDates: true
                    });

                    for (const sheetName of workbook.SheetNames) {
                        const sheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(sheet, {
                            defval: null,
                            raw: false,
                            dateNF: 'yyyy-mm-dd'
                        });

                        if (selectedFileType === 'monthly') {
                            let dataType = sheetName;
                            if (sheetName.includes('ì˜ë¥˜')) dataType = 'ì˜ë¥˜';
                            else if (sheetName.includes('ì‹ ë°œ')) dataType = 'ì‹ ë°œ';
                            else if (sheetName.includes('ì¡í™”')) dataType = 'ì¡í™”';
                            sheetInfo.push({ sheetName, dataType, startIdx: allRows.length, count: jsonData.length });
                        }

                        // POS í¬ë§· ê°ì§€ (ì›”ë³„ ì»¬ëŸ¼ ì¡´ì¬ í™•ì¸)
                        if (jsonData.length > 0) {
                            const cols = Object.keys(jsonData[0]);
                            const isPosFormat = cols.some(c => /^(1ì›”|2ì›”|3ì›”|4ì›”|5ì›”|6ì›”|7ì›”|8ì›”|9ì›”|10ì›”|11ì›”|12ì›”)$/.test(c));
                            if (isPosFormat) {
                                console.log('POS í¬ë§· ê°ì§€:', cols);
                            }
                        }

                        allRows = allRows.concat(jsonData.map(row => ({...row, _sheet: sheetName})));
                    }
                }

                progressDiv.style.display = 'none';

                // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                showPreview(allRows, file, sheetInfo);

            } catch (error) {
                progressDiv.style.display = 'none';
                showToast('íŒŒì¼ ë¶„ì„ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        function showPreview(rows, file, sheetInfo = []) {
            pendingData = { rows, sheetInfo };
            pendingFile = file;

            const previewArea = document.getElementById('previewArea');
            const previewStats = document.getElementById('previewStats');
            const previewHeader = document.getElementById('previewHeader');
            const previewBody = document.getElementById('previewBody');

            // í†µê³„ ìƒì„±
            let statsHtml = `
                <div style="background: #e3f2fd; padding: 10px 15px; border-radius: 8px;">
                    <strong>ğŸ“„ íŒŒì¼ëª…:</strong> ${file.name}
                </div>
                <div style="background: #e8f5e9; padding: 10px 15px; border-radius: 8px;">
                    <strong>ğŸ“Š ì´ í–‰ìˆ˜:</strong> ${rows.length.toLocaleString()}í–‰
                </div>
                <div style="background: #fff3e0; padding: 10px 15px; border-radius: 8px;">
                    <strong>ğŸ“ íŒŒì¼ íƒ€ì…:</strong> ${selectedFileType === 'original' ? 'ì›ë³¸' : selectedFileType === 'monthly' ? 'ì›”ë³„' : selectedFileType === 'pos' ? 'POS (â†’ ì›”ë³„ ë³€í™˜)' : 'ì»¤ìŠ¤í…€'}
                </div>
            `;

            // ì›”ë³„ ë°ì´í„°ì˜ ê²½ìš° ì‹œíŠ¸ë³„ ì •ë³´ í‘œì‹œ
            if (sheetInfo.length > 0) {
                statsHtml += `<div style="background: #f3e5f5; padding: 10px 15px; border-radius: 8px;">
                    <strong>ğŸ“‘ ì‹œíŠ¸:</strong> ${sheetInfo.map(s => `${s.dataType}(${s.count.toLocaleString()}í–‰)`).join(', ')}
                </div>`;
            }

            // ì›ë³¸ ë°ì´í„°ì˜ ê²½ìš° ë§¤ì¶œì•¡ í•©ê³„ ê³„ì‚°
            if (selectedFileType === 'original' && rows.length > 0) {
                let totalSales = 0;
                let totalQty = 0;
                rows.forEach(row => {
                    const sales = parseFloat(String(row['ì‹¤íŒë§¤ê¸ˆì•¡'] || row['íŒë§¤ê¸ˆì•¡'] || 0).replace(/,/g, '')) || 0;
                    const qty = parseFloat(String(row['íŒë§¤ëŸ‰'] || row['ìˆ˜ëŸ‰'] || 0).replace(/,/g, '')) || 0;
                    totalSales += sales;
                    totalQty += qty;
                });
                if (totalSales > 0) {
                    statsHtml += `<div style="background: #e1f5fe; padding: 10px 15px; border-radius: 8px;">
                        <strong>ğŸ’° ì´ ë§¤ì¶œ:</strong> ${(totalSales / 100000000).toFixed(2)}ì–µì›
                    </div>`;
                }
                if (totalQty > 0) {
                    statsHtml += `<div style="background: #fce4ec; padding: 10px 15px; border-radius: 8px;">
                        <strong>ğŸ“¦ ì´ íŒë§¤ëŸ‰:</strong> ${totalQty.toLocaleString()}ê°œ
                    </div>`;
                }
            }

            previewStats.innerHTML = statsHtml;

            // í…Œì´ë¸” í—¤ë” ìƒì„± (ì²« ë²ˆì§¸ í–‰ì˜ í‚¤ ì‚¬ìš©)
            if (rows.length > 0) {
                const sampleRow = rows[0];
                const keys = Object.keys(sampleRow).filter(k => k !== '_sheet').slice(0, 10); // ìµœëŒ€ 10ê°œ ì»¬ëŸ¼

                previewHeader.innerHTML = '<tr>' + keys.map(k => `<th>${k}</th>`).join('') + '</tr>';

                // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„° (ì²˜ìŒ 20í–‰)
                const previewRows = rows.slice(0, 20);
                previewBody.innerHTML = previewRows.map(row =>
                    '<tr>' + keys.map(k => {
                        let val = row[k];
                        if (val === null || val === undefined) val = '';
                        // ìˆ«ìëŠ” í¬ë§·íŒ…
                        if (typeof val === 'number') {
                            val = val.toLocaleString();
                        }
                        // ê¸´ í…ìŠ¤íŠ¸ëŠ” ìë¥´ê¸°
                        if (String(val).length > 30) {
                            val = String(val).substring(0, 30) + '...';
                        }
                        return `<td>${val}</td>`;
                    }).join('') + '</tr>'
                ).join('');

                if (rows.length > 20) {
                    previewBody.innerHTML += `<tr><td colspan="${keys.length}" style="text-align: center; color: #888; font-style: italic;">... ì™¸ ${(rows.length - 20).toLocaleString()}í–‰ ë” ìˆìŒ</td></tr>`;
                }
            }

            previewArea.style.display = 'block';
            uploadArea.style.display = 'none';
        }

        function cancelPreview() {
            pendingData = null;
            pendingFile = null;

            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('previewStats').innerHTML = '';
            document.getElementById('previewHeader').innerHTML = '';
            document.getElementById('previewBody').innerHTML = '';

            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('fileInput').value = '';
        }

        async function confirmUpload() {
            if (!pendingData || !pendingFile) {
                showToast('ì—…ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // POS ë°ì´í„°ëŠ” monthly íƒ€ì…ìœ¼ë¡œ ì €ì¥
            const uploadType = selectedFileType === 'pos' ? 'monthly' : selectedFileType;

            // ì‹¤ì œ ì—…ë¡œë“œ ì§„í–‰
            uploadFile(pendingFile, pendingData.rows, pendingData.sheetInfo, uploadType);
        }

        // íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ì½ê¸° (ì¸ì½”ë”© ì§€ì •)
        function readFileAsText(file, encoding = 'utf-8') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsText(file, encoding);
            });
        }

        async function uploadFile(file, preloadedRows = null, preloadedSheetInfo = null, uploadType = null) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            // uploadTypeì´ ì§€ì •ë˜ì§€ ì•Šìœ¼ë©´ selectedFileType ì‚¬ìš©
            const fileType = uploadType || selectedFileType;

            // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ ìˆ¨ê¸°ê³  ì—…ë¡œë“œ ì˜ì—­ í‘œì‹œ
            document.getElementById('previewArea').style.display = 'none';
            document.getElementById('uploadArea').style.display = 'block';

            progressDiv.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...';

            try {
                // ì´ë¯¸ íŒŒì‹±ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ìƒˆë¡œ íŒŒì‹±
                let allRows = preloadedRows || [];
                let sheetInfo = preloadedSheetInfo || [];

                if (!preloadedRows) {
                    // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ íŒŒì‹± (ê¸°ì¡´ ë¡œì§)
                    const ext = file.name.split('.').pop().toLowerCase();

                    // ì›ë³¸ ë°ì´í„° (.xls í™•ì¥ìì§€ë§Œ ì‹¤ì œ TSV í˜•ì‹) ë˜ëŠ” CSVëŠ” í…ìŠ¤íŠ¸ë¡œ íŒŒì‹±
                    if (fileType === 'original' || ext === 'csv') {
                        // í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì½ê¸° (cp949 ì¸ì½”ë”©)
                        const text = await readFileAsText(file, 'euc-kr');
                        const lines = text.split('\n').filter(line => line.trim());

                        if (lines.length < 2) {
                            throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                        }

                        // íƒ­ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„
                        const delimiter = lines[0].includes('\t') ? '\t' : ',';
                        const headers = lines[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));

                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(delimiter).map(v => v.trim().replace(/"/g, ''));
                            if (values.length >= headers.length - 5) { // ì¼ë¶€ ì»¬ëŸ¼ ëˆ„ë½ í—ˆìš©
                                const row = {};
                                headers.forEach((header, idx) => {
                                    row[header] = values[idx] !== undefined ? values[idx] : null;
                                });
                                allRows.push(row);
                            }
                        }
                        console.log('TSV/CSV íŒŒì‹± ì™„ë£Œ:', allRows.length, 'í–‰, ì»¬ëŸ¼:', headers.slice(0, 5));

                    } else {
                        // ì§„ì§œ Excel íŒŒì¼ (.xlsx, ì›”ë³„ ë°ì´í„°)
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data, { type: 'array', codepage: 949 });

                        for (const sheetName of workbook.SheetNames) {
                            const sheet = workbook.Sheets[sheetName];
                            const jsonData = XLSX.utils.sheet_to_json(sheet, { defval: null });

                            if (fileType === 'monthly') {
                                let dataType = sheetName;
                                if (sheetName.includes('ì˜ë¥˜')) dataType = 'ì˜ë¥˜';
                                else if (sheetName.includes('ì‹ ë°œ')) dataType = 'ì‹ ë°œ';
                                else if (sheetName.includes('ì¡í™”')) dataType = 'ì¡í™”';
                                sheetInfo.push({ sheetName, dataType, startIdx: allRows.length, count: jsonData.length });
                            }
                            allRows = allRows.concat(jsonData.map(row => ({...row, _sheet: sheetName})));
                        }
                    }
                }

                progressText.textContent = `${allRows.length.toLocaleString()}í–‰ ë°ì´í„° ì—…ë¡œë“œ ì¤‘...`;

                // ì²­í¬ë¡œ ë‚˜ëˆ„ê¸° (1000ê±´ì”© - ì†ë„ ê°œì„ )
                const CHUNK_SIZE = 1000;
                const PARALLEL_REQUESTS = 3;  // ë™ì‹œ ìš”ì²­ ìˆ˜
                const totalChunks = Math.ceil(allRows.length / CHUNK_SIZE);
                let fileId = null;
                let totalInserted = 0;
                let completedChunks = 0;

                // ì²­í¬ ì¤€ë¹„
                const chunks = [];
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, allRows.length);
                    const chunk = allRows.slice(start, end);

                    let dataType = '';
                    if (fileType === 'monthly' && chunk.length > 0) {
                        const firstRow = chunk[0];
                        const info = sheetInfo.find(s => firstRow._sheet === s.sheetName);
                        dataType = info ? info.dataType : (firstRow._sheet || 'POS');
                    }

                    const cleanChunk = chunk.map(row => {
                        const {_sheet, ...rest} = row;
                        return rest;
                    });

                    chunks.push({ index: i, rows: cleanChunk, dataType, start, end });
                }

                // ì²« ì²­í¬ëŠ” ë‹¨ë…ìœ¼ë¡œ ë³´ë‚´ì„œ file_id ë°›ê¸°
                progressText.textContent = `íŒŒì¼ ë“±ë¡ ì¤‘...`;
                const firstChunk = chunks[0];
                const firstResponse = await fetch('/api/upload-chunk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        file_id: null,
                        file_type: fileType,
                        rows: firstChunk.rows,
                        chunk_index: 0,
                        total_chunks: totalChunks,
                        original_name: file.name,
                        data_type: firstChunk.dataType
                    })
                });
                const firstResult = await firstResponse.json();
                if (!firstResult.success) throw new Error(firstResult.error || 'ì´ˆê¸°í™” ì‹¤íŒ¨');
                fileId = firstResult.file_id;
                totalInserted += firstResult.inserted;
                completedChunks = 1;
                progressFill.style.width = (1 / totalChunks * 100) + '%';

                // ë‚˜ë¨¸ì§€ ì²­í¬ëŠ” ë³‘ë ¬ë¡œ ì²˜ë¦¬
                const remainingChunks = chunks.slice(1);
                for (let batch = 0; batch < remainingChunks.length; batch += PARALLEL_REQUESTS) {
                    const batchChunks = remainingChunks.slice(batch, batch + PARALLEL_REQUESTS);
                    progressText.textContent = `ì—…ë¡œë“œ ì¤‘... ${completedChunks}/${totalChunks} ì™„ë£Œ (${Math.round(completedChunks / totalChunks * 100)}%)`;

                    const promises = batchChunks.map(chunk =>
                        fetch('/api/upload-chunk', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                file_id: fileId,
                                file_type: fileType,
                                rows: chunk.rows,
                                chunk_index: chunk.index,
                                total_chunks: totalChunks,
                                original_name: file.name,
                                data_type: chunk.dataType
                            })
                        }).then(r => r.json())
                    );

                    const results = await Promise.all(promises);
                    for (const result of results) {
                        if (!result.success) console.error('ì²­í¬ ì‹¤íŒ¨:', result.error);
                        else totalInserted += result.inserted;
                        completedChunks++;
                    }
                    progressFill.style.width = (completedChunks / totalChunks * 100) + '%';
                }

                progressFill.style.width = '100%';
                progressText.textContent = `ì™„ë£Œ! ${totalInserted.toLocaleString()}í–‰ ì €ì¥ë¨`;
                showToast(`íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ: ${totalInserted.toLocaleString()}í–‰ ì €ì¥ë¨`, 'success');

                // pending ë°ì´í„° ì´ˆê¸°í™”
                pendingData = null;
                pendingFile = null;

                setTimeout(() => location.reload(), 1500);

            } catch (error) {
                console.error('Upload error:', error);
                progressText.textContent = 'ì—…ë¡œë“œ ì˜¤ë¥˜';
                showToast('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + error.message, 'error');
            }
        }

        async function deleteFile(fileId, filename) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê´€ë ¨ ë°ì´í„°ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;

            try {
                const response = await fetch('/api/delete-file', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ file_id: fileId, filename: filename })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(result.error, 'error');
                }
            } catch (error) {
                showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>
